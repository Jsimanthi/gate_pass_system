echo "--- Starting Flutter Setup ---"

# --- 1. Flutter SDK Setup ---
echo "1. Installing and configuring Flutter SDK..."
FLUTTER_VERSION="3.32.8"
FLUTTER_INSTALL_DIR="/opt/flutter"

if [ ! -d "$FLUTTER_INSTALL_DIR" ]; then
    echo "Flutter SDK not found at $FLUTTER_INSTALL_DIR. Downloading and installing..."
    sudo mkdir -p "$FLUTTER_INSTALL_DIR"
    CURRENT_USER=$(whoami)
    CURRENT_GROUP=$(id -gn)
    sudo chown "$CURRENT_USER":"$CURRENT_GROUP" "$FLUTTER_INSTALL_DIR"
    if [ $? -ne 0 ]; then
        echo "Warning: Failed to change ownership of $FLUTTER_INSTALL_DIR to $CURRENT_USER:$CURRENT_GROUP. This might cause permission issues later."
    else
        echo "Changed ownership of $FLUTTER_INSTALL_DIR to $CURRENT_USER:$CURRENT_GROUP."
    fi
    curl -o flutter_sdk.tar.xz "https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz"
    if [ $? -ne 0 ]; then
        echo "Error: Flutter SDK download failed. Exiting."
        exit 1
    fi
    tar -xf flutter_sdk.tar.xz -C "$FLUTTER_INSTALL_DIR" --strip-components=1
    if [ $? -ne 0 ]; then
        echo "Error: Flutter SDK extraction failed. Exiting."
        exit 1
    fi
    rm flutter_sdk.tar.xz
    echo "Flutter SDK downloaded and extracted to $FLUTTER_INSTALL_DIR."
else
    echo "Flutter SDK already exists at $FLUTTER_INSTALL_DIR. Skipping download."
fi
export PATH="$PATH:$FLUTTER_INSTALL_DIR/bin"
echo "Added $FLUTTER_INSTALL_DIR/bin to PATH for this session."

# --- 2. Verify Flutter Installation ---
echo "2. Verifying Flutter installation with 'flutter doctor -v'..."
flutter doctor -v
if [ $? -ne 0 ]; then
    echo "Error: 'flutter doctor -v' failed. Flutter might not be correctly installed or in PATH. Exiting."
    exit 1
fi

# --- 3. Clean and Get Flutter Dependencies ---
echo "3. Cleaning Flutter build cache and fetching dependencies..."

# CORRECTED PATH: Use the path we found from the previous output
cd /app/frontend/gatepass_app
if [ $? -ne 0 ]; then
    echo "Error: Could not change directory to /app/frontend/gatepass_app. The path is still wrong."
    echo "This is unexpected. Please check the repository structure again."
    ls -F /app/frontend
    exit 1
fi
echo "Changed current working directory to: $(pwd)"
flutter clean
flutter pub get
if [ $? -ne 0 ]; then
    echo "Error: 'flutter pub get' failed. Check your pubspec.yaml or network connectivity. Exiting."
    exit 1
fi

echo "--- Flutter Setup ---"